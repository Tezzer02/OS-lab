#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdlib.h>
#include <fcntl.h>

int main() {
    int p1[2], p2[2];
    pid_t pid;
    char input[500], buffer[500];
    int characters, words, lines;

    pipe(p1);    // Parent → Child
    pipe(p2);    // Child → Parent

    pid = fork();

    if (pid > 0) {
        // Parent Process
        close(p1[0]);  // Close read end of p1
        close(p2[1]);  // Close write end of p2

        printf("Enter text (type END to stop):");
        fgets(input, sizeof(input), stdin);

        write(p1[1], input, strlen(input) + 1);

        read(p2[0], buffer, sizeof(buffer));

        printf("\nOutput from Child Process:\n%s\n", buffer);

    } else if (pid == 0) {
        // Child Process
        close(p1[1]);  // Close write end of p1
        close(p2[0]);  // Close read end of p2

        read(p1[0], input, sizeof(input));

        if (strcmp(input, "END\n") == 0) {
            exit(0);
        }

        characters = strlen(input) - 1;
        words = 0;
        lines = 1;

        for (int i = 0; input[i] != '\0'; i++) {
            if (input[i] == ' ' || input[i] == '\n')
                words++;
            if (input[i] == '\n')
                lines++;
        }

        FILE *fp = fopen("output.txt", "w");
        fprintf(fp, "Characters: %d\nWords: %d\nLines: %d\n", characters, words, lines);
        fclose(fp);

        fp = fopen("output.txt", "r");
        fread(buffer, sizeof(char), 500, fp);
        fclose(fp);

        write(p2[1], buffer, strlen(buffer) + 1);

    } else {
        printf("Fork failed.\n");
    }

    return 0;
}

//how to run
//gcc duplex.c -o duplex
//./duplex